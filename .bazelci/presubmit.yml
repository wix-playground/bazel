---
platforms:
  ubuntu1404:
    shell_commands:
    - sed -i.bak -e 's/^# android_sdk_repository/android_sdk_repository/' -e 's/^#
      android_ndk_repository/android_ndk_repository/' WORKSPACE
    - rm -f WORKSPACE.bak
    build_targets:
    - "//src:bazel"
    - "//src:bazel_jdk_minimal"
    test_flags:
    - "--test_timeout=1200"
    test_targets:
    - "--"
    - "//scripts/..."
    - "//src/test/..."
    - "//src/tools/execlog/..."
    - "//src/tools/singlejar/..."
    - "//src/tools/workspacelog/..."
    - "//third_party/ijar/..."
    - "//tools/android/..."
    - "//tools/aquery_differ/..."
    # Disable Slow Tests
    - "-//src/test/shell/bazel:bazel_determinism_test"
    # Re-enable once fixed: https://github.com/bazelbuild/bazel/issues/4663
    - "-//src/test/shell/bazel/android:android_ndk_integration_test"
  ubuntu1604:
    shell_commands:
    - sed -i.bak -e 's/^# android_sdk_repository/android_sdk_repository/' -e 's/^#
      android_ndk_repository/android_ndk_repository/' WORKSPACE
    - rm -f WORKSPACE.bak
    build_targets:
    - "//src:bazel"
    - "//src:bazel_jdk_minimal"
    test_flags:
    - "--test_timeout=1200"
    test_targets:
    - "--"
    - "//scripts/..."
    - "//src/test/..."
    - "//src/tools/execlog/..."
    - "//src/tools/singlejar/..."
    - "//src/tools/workspacelog/..."
    - "//third_party/ijar/..."
    - "//tools/android/..."
    - "//tools/aquery_differ/..."
    # Disable Slow Tests
    - "-//src/test/shell/bazel:bazel_determinism_test"
    # Re-enable once fixed: https://github.com/bazelbuild/bazel/issues/4663
    - "-//src/test/shell/bazel/android:android_ndk_integration_test"
  ubuntu1804:
    shell_commands:
    - sed -i.bak -e 's/^# android_sdk_repository/android_sdk_repository/' -e 's/^#
      android_ndk_repository/android_ndk_repository/' WORKSPACE
    - rm -f WORKSPACE.bak
    build_targets:
    - "//src:bazel"
    - "//src:bazel_jdk_minimal"
    test_flags:
    - "--test_timeout=1200"
    test_targets:
    - "--"
    - "//scripts/..."
    - "//src/test/..."
    - "//src/tools/execlog/..."
    - "//src/tools/singlejar/..."
    - "//src/tools/workspacelog/..."
    - "//third_party/ijar/..."
    - "//tools/android/..."
    - "//tools/aquery_differ/..."
    # Disable Slow Tests
    - "-//src/test/shell/bazel:bazel_determinism_test"
    # Re-enable once fixed: https://github.com/bazelbuild/bazel/issues/4663
    - "-//src/test/shell/bazel/android:android_ndk_integration_test"
  ubuntu1804_nojava:
    build_flags:
    - "--javabase=@openjdk_linux_archive//:runtime"
    build_targets:
    - "//src:bazel"
    - "//src:bazel_jdk_minimal"
    test_flags:
    - "--javabase=@openjdk_linux_archive//:runtime"
    - "--test_timeout=1200"
    test_targets:
    - "--"
    - "//scripts/..."
    - "//src/test/..."
    - "//src/tools/execlog/..."
    - "//src/tools/singlejar/..."
    - "//src/tools/workspacelog/..."
    - "//third_party/ijar/..."
    - "//tools/aquery_differ/..."
    # Disable Slow Tests
    - "-//src/test/shell/bazel:bazel_determinism_test"
    # We can't run Android tests without an installed Android SDK / NDK.
    - "-//src/test/java/com/google/devtools/build/android/..."
    - "-//src/test/shell/bazel/android/..."
    # Currently broken tests on this platform.
    # These tests do not work without an installed system JDK:
    # (see https://github.com/bazelbuild/bazel/issues/6214#issuecomment-424813868)
    # TODO(philwo): Use tags instead of an explicit blacklist.
    - "-//src/test/py/bazel:launcher_test"
    - "-//src/test/py/bazel:runfiles_test"
    - "-//src/test/shell/bazel:bazel_bootstrap_distfile_test"
    - "-//src/test/shell/bazel:bazel_coverage_cc_test_gcc"
    - "-//src/test/shell/bazel:bazel_coverage_cc_test_llvm"
    - "-//src/test/shell/bazel:bazel_coverage_java_test"
    - "-//src/test/shell/bazel:bazel_coverage_sh_test"
    - "-//src/test/shell/bazel:bazel_determinism_test"
    - "-//src/test/shell/bazel:bazel_example_test"
    - "-//src/test/shell/bazel:bazel_java_test"
    - "-//src/test/shell/bazel:bazel_random_characters_test"
    - "-//src/test/shell/bazel:bazel_repository_cache_test"
    - "-//src/test/shell/bazel:bazel_rules_test"
    - "-//src/test/shell/bazel:bazel_sandboxing_test"
    - "-//src/test/shell/bazel:bazel_test_test"
    - "-//src/test/shell/bazel:empty_package_test"
    - "-//src/test/shell/bazel:external_integration_test"
    - "-//src/test/shell/bazel:java_launcher_test"
    - "-//src/test/shell/bazel:local_repository_test"
    - "-//src/test/shell/bazel:maven_test"
    - "-//src/test/shell/bazel:runfiles_test"
    - "-//src/test/shell/integration:bazel_java_test"
    - "-//src/test/shell/integration:bazel_sandboxed_worker_test"
    - "-//src/test/shell/integration:bazel_worker_test"
    - "-//src/test/shell/integration:discard_analysis_cache_test"
    - "-//src/test/shell/integration:discard_graph_edges_test"
    - "-//src/test/shell/integration:java_integration_test"
    - "-//src/test/shell/integration:jvm_flags_escaping_test"
    - "-//src/test/shell/integration:minimal_jdk_test"
    - "-//src/test/shell/integration:nonincremental_builds_test"
    - "-//src/test/shell/integration:output_filter_test"
    - "-//src/test/shell/integration:stub_finds_runfiles_test"
    - "-//src/test/shell/integration:test_test"
    - "-//src/tools/singlejar:zip64_test"
  ubuntu1804_java9:
    shell_commands:
    - sed -i.bak -e 's/^# android_sdk_repository/android_sdk_repository/' -e 's/^#
      android_ndk_repository/android_ndk_repository/' WORKSPACE
    - rm -f WORKSPACE.bak
    build_targets:
    - "//src:bazel"
    - "//src:bazel_jdk_minimal"
    test_flags:
    - "--test_timeout=1200"
    test_targets:
    - "--"
    - "//scripts/..."
    - "//src/test/..."
    - "//src/tools/execlog/..."
    - "//src/tools/singlejar/..."
    - "//src/tools/workspacelog/..."
    - "//third_party/ijar/..."
    - "//tools/android/..."
    - "//tools/aquery_differ/..."
    # Disable Slow Tests
    - "-//src/test/shell/bazel:bazel_determinism_test"
    # Re-enable once fixed: https://github.com/bazelbuild/bazel/issues/4663
    - "-//src/test/shell/bazel/android:android_ndk_integration_test"
  ubuntu1804_java10:
    shell_commands:
    - sed -i.bak -e 's/^# android_sdk_repository/android_sdk_repository/' -e 's/^#
      android_ndk_repository/android_ndk_repository/' WORKSPACE
    - rm -f WORKSPACE.bak
    build_targets:
    - "//src:bazel"
    - "//src:bazel_jdk_minimal"
    test_flags:
    - "--test_timeout=1200"
    test_targets:
    - "--"
    - "//scripts/..."
    - "//src/test/..."
    - "//src/tools/execlog/..."
    - "//src/tools/singlejar/..."
    - "//src/tools/workspacelog/..."
    - "//third_party/ijar/..."
    - "//tools/android/..."
    - "//tools/aquery_differ/..."
    # Disable Slow Tests
    - "-//src/test/shell/bazel:bazel_determinism_test"
    # Re-enable once fixed: https://github.com/bazelbuild/bazel/issues/4663
    - "-//src/test/shell/bazel/android:android_ndk_integration_test"
  ubuntu1804_java11:
    shell_commands:
    - sed -i.bak -e 's/^# android_sdk_repository/android_sdk_repository/' -e 's/^#
      android_ndk_repository/android_ndk_repository/' WORKSPACE
    - rm -f WORKSPACE.bak
    build_targets:
    - "//src:bazel"
    - "//src:bazel_jdk_minimal"
    test_flags:
    - "--test_timeout=1200"
    test_targets:
    - "--"
    - "//scripts/..."
    - "//src/test/..."
    - "//src/tools/execlog/..."
    - "//src/tools/singlejar/..."
    - "//src/tools/workspacelog/..."
    - "//third_party/ijar/..."
    - "//tools/android/..."
    - "//tools/aquery_differ/..."
    # Disable Slow Tests
    - "-//src/test/shell/bazel:bazel_determinism_test"
    # Re-enable once fixed: https://github.com/bazelbuild/bazel/issues/4663
    - "-//src/test/shell/bazel/android:android_ndk_integration_test"
    # Some prebuilt jars doesn't run with Java 11
    - "-//src/test/shell/bazel:external_integration_test"
    - "-//src/test/shell/bazel:maven_test"
    # Re-enable once bootstrap works with Java 11
    - "-//src/test/shell/bazel:bazel_bootstrap_distfile_test"
  macos:
    shell_commands:
    - sed -i.bak -e 's/^# android_sdk_repository/android_sdk_repository/' -e 's/^#
      android_ndk_repository/android_ndk_repository/' WORKSPACE
    - rm -f WORKSPACE.bak
    build_flags:
    - "--apple_platform_type=macos"
    # Remove when https://github.com/bazelbuild/bazel/issues/7026 is fixed.
    - "--noincompatible_strict_action_env"
    build_targets:
    - "//src:bazel"
    - "//src:bazel_jdk_minimal"
    test_flags:
    - "--test_timeout=1200"
    # Remove when https://github.com/bazelbuild/bazel/issues/7026 is fixed.
    - "--noincompatible_strict_action_env"
    test_targets:
    - "--"
    - "//scripts/..."
    - "//src/test/..."
    - "//src/tools/execlog/..."
    - "//src/tools/singlejar/..."
    - "//src/tools/workspacelog/..."
    - "//third_party/ijar/..."
    - "//tools/android/..."
    - "//tools/aquery_differ/..."
    # Re-enable once fixed: https://github.com/bazelbuild/bazel/issues/4663
    - "-//src/test/shell/bazel/android:android_ndk_integration_test"
    # The below tests have been disabled because they are too slow on macOS.
    # Re-enable once fixed: https://github.com/bazelbuild/bazel/issues/4684
    - "-//src/test/shell/bazel:bazel_determinism_test"
    - "-//src/test/shell/bazel:bazel_java_test"
    - "-//src/test/shell/bazel:bazel_bootstrap_distfile_test"
    - "-//src/test/shell/bazel/remote:remote_execution_test"
    - "-//src/test/shell/bazel/remote:remote_execution_http_test"
    - "-//src/test/shell/bazel:skylark_git_repository_test"
    - "-//src/test/shell/bazel:external_path_test"
    - "-//src/test/py/bazel:runfiles_test"
    - "-//src/test/shell/bazel:git_repository_test"
    - "-//src/test/shell/bazel/android:aar_integration_test"
    - "-//src/test/shell/bazel/android:android_integration_test"
    - "-//src/test/shell/integration:minimal_jdk_test"
  windows:
    batch_commands:
    - powershell -Command "(Get-Content WORKSPACE) -Replace '# android_', 'android_' | Set-Content WORKSPACE"
    build_flags:
    - "--copt=-w"
    - "--host_copt=-w"
    # Remove when https://github.com/bazelbuild/bazel/issues/7026 is fixed.
    - "--noincompatible_strict_action_env"
    build_targets:
    - "//src:bazel"
    - "//src:bazel_jdk_minimal"
    test_flags:
    - "--copt=-w"
    - "--host_copt=-w"
    - "--test_env=JAVA_HOME"
    - "--test_timeout=1200"
    # Remove when https://github.com/bazelbuild/bazel/issues/7026 is fixed.
    - "--noincompatible_strict_action_env"
    test_targets:
    - "--"
    - "//src:all_windows_tests"
  rbe_ubuntu1604:
    shell_commands:
    - sed -i.bak -e 's/^# android_sdk_repository/android_sdk_repository/'
      -e 's/^# android_ndk_repository/android_ndk_repository/'
      -e 's/^# rbe_autoconfig/rbe_autoconfig/'
      -e 's/^# load("@bazel_toolchains/load("@bazel_toolchains/' WORKSPACE
    - rm -f WORKSPACE.bak
    build_targets:
    - "//src:bazel"
    - "//src:bazel_jdk_minimal"
